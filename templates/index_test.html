<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multilingual Sentiment Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --neutral: #94a3b8;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --radius: 14px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 2rem 1rem;
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 { font-size: 2.25rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .subtitle { color: var(--text-muted); font-size: 1.1rem; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        .card { background: var(--card); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); }

        label { display: block; font-weight: 600; margin-bottom: 0.75rem; }
        textarea { 
            width: 100%; 
            height: 160px; 
            padding: 1rem; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            font-family: 'Inter', monospace; 
            font-size: 1rem; 
            resize: vertical;
            margin-bottom: 1rem;
        }
        .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary {
            background: #f1f5f9;
            color: var(--text);
        }
        .btn-secondary:hover { background: #e2e8f0; }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
        .history-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        .history-item:last-child { border: none; }
        .history-text { font-style: italic; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-meta { display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.85rem; }
        .lang-badge { background: #dbeafe; color: #1d4ed8; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.8rem; }

        .result-card {
            background: var(--card);
            padding: 1.75rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 2rem;
            display: none;
        }
        .result-card.show { display: block; }
        .sentiment-emoji { font-size: 3.5rem; margin: 0.5rem 0; }
        .sentiment-label { font-size: 1.5rem; font-weight: 700; margin: 0.5rem 0; }
        .sentiment-score { color: var(--text-muted); margin-bottom: 1rem; }
        .language-info {
            background: #f0f9ff;
            padding: 0.5rem;
            border-radius: var(--radius);
            font-size: 0.95rem;
            color: #0c4a6e;
        }

        .error { 
            background: #fee; 
            color: var(--danger); 
            padding: 1rem; 
            border-radius: var(--radius); 
            margin-bottom: 1.5rem;
            display: none;
        }
        .error.show { display: block; }

        footer { text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.9rem; }
        footer a { color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> Multilingual Sentiment Analysis</h1>
            <p class="subtitle">Analyse de sentiment en plusieurs langues via OpenAI</p>
        </header>

        <div class="grid">
            <div class="card">
                <label for="input-text">Texte √† analyser</label>
                <textarea id="input-text" placeholder="Saisissez du texte en fran√ßais, anglais, espagnol, chinois, etc."></textarea>
                <div class="btn-group">
                    <button id="analyze-btn" class="btn-primary">
                        <i class="fas fa-search"></i> Analyser
                    </button>
                    <button id="clear-btn" class="btn-secondary">
                        <i class="fas fa-trash"></i> Effacer
                    </button>
                </div>
            </div>

            <!-- Dans la deuxi√®me colonne, section historique -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Historique des analyses</h3>
                    <button id="clear-history-btn" class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                        <i class="fas fa-trash"></i> Tout effacer
                    </button>
                </div>
                <div id="history-list" class="history-list">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
        </div>

        <div id="error-box" class="error">
            <i class="fas fa-exclamation-triangle"></i> <span id="error-msg"></span>
        </div>

        <div id="result-card" class="result-card">
            <h2>R√©sultat</h2>
            <div class="sentiment-emoji" id="sentiment-emoji">üòê</div>
            <div class="sentiment-label" id="sentiment-label">Neutral</div>
            <div class="sentiment-score" id="sentiment-score">Confiance : 0%</div>
            <div class="language-info" id="language-info">Langue d√©tect√©e : inconnue</div>
        </div>

        <footer>
            <p>Langues support√©es : 23+ ‚Ä¢ Analyse via OpenAI GPT-3.5 ‚Ä¢ Historique stock√© localement</p>
        </footer>
    </div>

    <script>
        const inputText = document.getElementById('input-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const errorBox = document.getElementById('error-box');
        const errorMsg = document.getElementById('error-msg');
        const resultCard = document.getElementById('result-card');
        const sentimentEmoji = document.getElementById('sentiment-emoji');
        const sentimentLabel = document.getElementById('sentiment-label');
        const sentimentScore = document.getElementById('sentiment-score');
        const languageInfo = document.getElementById('language-info');
        const historyList = document.getElementById('history-list');
    
        // Charger l‚Äôhistorique depuis le serveur
        async function loadHistoryFromServer() {
            try {
                const res = await fetch('/history');
                const history = await res.json();
                renderHistory(history);
            } catch (err) {
                console.warn('Impossible de charger l‚Äôhistorique:', err);
                historyList.innerHTML = '<div class="history-item"><em>Historique indisponible</em></div>';
            }
        }
    
        function renderHistory(history) {
            historyList.innerHTML = '';
            if (!Array.isArray(history) || history.length === 0) {
                historyList.innerHTML = '<div class="history-item"><em>Aucun historique</em></div>';
                return;
            }
            // Afficher les plus r√©cents en bas ‚Üí on inverse l‚Äôordre visuel
            const recent = history.slice(-20).reverse();
            recent.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                const lang = item.language === 'undetermined' ? '??' : (item.language || '??');
                const displayText = item.text || item.full_text;
                div.innerHTML = `
                    <div class="history-text" title="${displayText}">"${displayText.length > 50 ? displayText.substring(0,50) + '‚Ä¶' : displayText}"</div>
                    <div class="history-meta">
                        <span>${getEmoji(item.label)} ${capitalize(item.label)}</span>
                        <span class="lang-badge">${lang.toUpperCase()}</span>
                    </div>
                `;
                historyList.appendChild(div);
            });
        }
    
        function getEmoji(label) {
            switch (label) {
                case 'very positive': case 'positive': return 'üòä';
                case 'very negative': case 'negative': return 'üòû';
                case 'neutral': return 'üòê';
                default: return 'ü§î';
            }
        }
    
        function capitalize(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : str;
        }
    
        function showError(message) {
            errorMsg.textContent = message;
            errorBox.classList.add('show');
            setTimeout(() => errorBox.classList.remove('show'), 5000);
        }
    
        analyzeBtn.addEventListener('click', async () => {
            const text = inputText.value.trim();
            if (!text) {
                showError('Veuillez saisir du texte.');
                return;
            }
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyse...';
    
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
    
                const data = await response.json();
    
                if (!response.ok) {
                    throw new Error(data.message || 'Erreur inconnue');
                }
    
                // Afficher r√©sultat
                sentimentEmoji.textContent = getEmoji(data.label);
                sentimentLabel.textContent = capitalize(data.label);
                sentimentScore.textContent = `Confiance : ${(data.score * 100).toFixed(1)}%`;
                const langDisplay = data.language === 'undetermined' ? 'inconnue' : data.language || 'inconnue';
                languageInfo.textContent = `Langue d√©tect√©e : ${langDisplay}`;
                resultCard.classList.add('show');
    
                // Recharger l‚Äôhistorique
                loadHistoryFromServer();
    
            } catch (err) {
                showError('Erreur : ' + err.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyser';
            }
        });
    
        clearBtn.addEventListener('click', () => {
            inputText.value = '';
            resultCard.classList.remove('show');
            inputText.focus();
        });

        // Bouton pour effacer tout l‚Äôhistorique
        document.getElementById('clear-history-btn').addEventListener('click', async () => {
            if (!confirm("Voulez-vous vraiment supprimer tout l‚Äôhistorique ? Cette action est irr√©versible.")) {
                return;
            }

            try {
                const response = await fetch('/clear-history', {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (response.ok) {
                    // Recharger l‚Äôhistorique (vide)
                    loadHistoryFromServer();
                    // Optionnel : afficher un petit message de succ√®s
                    showError(result.message); // r√©utilise la fonction existante pour afficher bri√®vement
                    errorBox.style.backgroundColor = '#dcfce7';
                    errorBox.style.color = '#065f46';
                } else {
                    throw new Error(result.message || 'Erreur inconnue');
                }
            } catch (err) {
                showError('Erreur lors de la suppression : ' + err.message);
                errorBox.style.backgroundColor = '#fee';
                errorBox.style.color = '#dc2626';
            }
        });
    
        // Charger au d√©marrage
        loadHistoryFromServer();
    </script>
</body>
</html>